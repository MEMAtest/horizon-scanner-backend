function renderStateManagementSection() {
  return "        // =================\n        // GLOBAL VARIABLES\n        // =================\n        let allUpdatesData = null;\n        let firmProfile = null;\n        let availableSectors = Array.isArray(window.availableSectors)\n            ? Array.from(new Set(window.availableSectors.map(normalizeSectorLabel).filter(Boolean)))\n            : [];\n        let workspaceStats = { pinnedItems: 0, savedSearches: 0, activeAlerts: 0 };\n        let analyticsPreviewData = null;\n        const ANALYTICS_LEVELS = ['Significant', 'Moderate', 'Informational'];\n        const DEFAULT_ANALYTICS_PERIOD = 'month';\n        let analyticsState = {\n            filters: { authority: '', sector: '', period: DEFAULT_ANALYTICS_PERIOD },\n            impactDistribution: null\n        };\n        let expandedStreams = new Set();\n\n        // CRITICAL: These must be window-scoped for FilterModule access\n        window.selectedAuthorities = window.selectedAuthorities || new Set();\n        window.selectedImpactLevels = window.selectedImpactLevels || new Set();\n        window.selectedUrgencies = window.selectedUrgencies || new Set();\n\n        let currentFilter = null;\n        let pinnedUrls = new Set();\n        let currentOffset = 0;\n        let itemsPerPage = 20;\n        let shareInProgress = false;\n\n        if (Array.isArray(window.__workspacePinnedUrls)) {\n            setPinnedUrlSet(window.__workspacePinnedUrls);\n        }\n\n        if (window.__workspaceStats && typeof window.__workspaceStats === 'object') {\n            workspaceStats = Object.assign({}, workspaceStats, window.__workspaceStats);\n        }\n\n        function toNumericCount(value, fallback = 0) {\n            const parsed = Number(value);\n            return Number.isFinite(parsed) ? parsed : fallback;\n        }\n\n        function setPinnedUrlSet(values) {\n            if (Array.isArray(values)) {\n                pinnedUrls = new Set(values.filter(Boolean).map(value => String(value)));\n            } else if (values instanceof Set) {\n                pinnedUrls = new Set(Array.from(values).filter(Boolean).map(value => String(value)));\n            } else {\n                pinnedUrls = new Set();\n            }\n            workspaceStats.pinnedItems = pinnedUrls.size;\n        }\n\n        async function synchronizePinnedState(options = {}) {\n            const module = window.WorkspaceModule;\n            if (!module) return pinnedUrls;\n            try {\n                let readyPromise = null;\n                if (typeof module.ready === 'function') {\n                    readyPromise = module.ready();\n                } else if (typeof module.init === 'function') {\n                    readyPromise = module.init();\n                }\n                if (readyPromise && typeof readyPromise.then === 'function') {\n                    await readyPromise;\n                }\n                if (typeof module.getPinnedUrls === 'function') {\n                    const urls = module.getPinnedUrls();\n                    if (Array.isArray(urls)) {\n                        setPinnedUrlSet(urls);\n                        if (!options.silent) {\n                            updateWorkspaceCounts();\n                        }\n                    }\n                }\n            } catch (error) {\n                console.warn('Pinned synchronization failed:', error);\n            }\n            return pinnedUrls;\n        }\n\n        window.addEventListener('workspace:pins', (event) => {\n            const detail = event && event.detail;\n            const urls = Array.isArray(detail?.urls)\n                ? detail.urls\n                : Array.isArray(detail)\n                    ? detail\n                    : [];\n            setPinnedUrlSet(urls);\n            updateWorkspaceCounts();\n            if (typeof syncBookmarkButtons === 'function') {\n                syncBookmarkButtons();\n            }\n        });\n\n        window.addEventListener('workspace:stats', (event) => {\n            const detail = event && event.detail;\n            if (detail && typeof detail === 'object') {\n                if ('pinnedItems' in detail) {\n                    workspaceStats.pinnedItems = toNumericCount(detail.pinnedItems, workspaceStats.pinnedItems);\n                }\n                if ('savedSearches' in detail) {\n                    workspaceStats.savedSearches = toNumericCount(detail.savedSearches, workspaceStats.savedSearches);\n                }\n                if ('activeAlerts' in detail) {\n                    workspaceStats.activeAlerts = toNumericCount(detail.activeAlerts, workspaceStats.activeAlerts);\n                }\n                updateWorkspaceCounts(detail);\n            }\n        });\n\n        let systemStatus = {\n            database: false,\n            api: false,\n            overall: false\n        };\n        let priorityHighlightLookup = {};\n        let reviewedHighlightIds = new Set();\n\n        const serverFilterCache = new Map();\n\n        function buildFilterKey(filters) {\n            return JSON.stringify({\n                category: filters.category || 'all',\n                authority: filters.authority || null,\n                sector: filters.sector || null,\n                impact: filters.impact || null,\n                urgency: filters.urgency || null,\n                range: filters.range || null,\n                search: filters.search || null,\n                sort: filters.sort || 'newest'\n            });\n        }\n\n        function buildFilterQuery(filters) {\n            const params = new URLSearchParams();\n            if (filters.category && filters.category !== 'all') params.set('category', filters.category);\n            if (filters.authority) params.set('authority', String(filters.authority));\n            if (filters.sector) params.set('sector', String(filters.sector));\n            if (filters.impact) params.set('impact', String(filters.impact));\n            if (filters.urgency) params.set('urgency', String(filters.urgency));\n            if (filters.range) params.set('range', String(filters.range));\n            if (filters.search) params.set('search', String(filters.search));\n            params.set('limit', '100');\n            return params;\n        }\n\n        async function fetchUpdatesFromServer(filters) {\n            const key = buildFilterKey(filters);\n            if (serverFilterCache.has(key)) {\n                return serverFilterCache.get(key);\n            }\n\n            try {\n                showMessage('Loading more updates for this filter...', 'info');\n                const params = buildFilterQuery(filters);\n                const response = await fetch('/api/updates?' + params.toString());\n                const data = await response.json();\n                if (data.success && Array.isArray(data.updates)) {\n                    serverFilterCache.set(key, data.updates);\n                    return data.updates;\n                }\n            } catch (error) {\n                console.error('Remote filter fetch failed:', error);\n                showMessage('Unable to load additional updates for this filter.', 'error');\n            }\n            return [];\n        }\n\n        function shouldFetchFromServer(filters, localCount) {\n            if (localCount > 0) return false;\n            if (filters.category && filters.category !== 'all') return true;\n            if (filters.authority) return true;\n            if (filters.sector) return true;\n            if (filters.impact) return true;\n            if (filters.urgency) return true;\n            if (filters.range) return true;\n            if (filters.search) return true;\n            return false;\n        }\n\n        function getBusinessImpactScore(update) {\n            return Number(update.business_impact_score || update.businessImpactScore || 0);\n        }\n\n        function renderImpactGauge(score, compact = false) {\n            if (score == null || isNaN(score)) {\n                return '<div class=\"impact-gauge ' + (compact ? 'compact ' : '') + 'impact-low\">' +\n                    '<div class=\"impact-gauge-track\"><div class=\"impact-gauge-fill impact-low\" style=\"width:0%\"></div></div>' +\n                    '<span class=\"impact-gauge-label\">N/A</span>' +\n                '</div>';\n            }\n\n            const clamped = Math.max(0, Math.min(10, Number(score)));\n            const percent = Math.round((clamped / 10) * 100);\n            const level = clamped >= 7 ? 'impact-high' : clamped >= 4 ? 'impact-medium' : 'impact-low';\n\n            return '<div class=\"impact-gauge ' + (compact ? 'compact ' : '') + level + '\">' +\n                '<div class=\"impact-gauge-track\">' +\n                    '<div class=\"impact-gauge-fill ' + level + '\" style=\"width:' + percent + '%\"></div>' +\n                '</div>' +\n                '<span class=\"impact-gauge-label\">' + clamped + '/10</span>' +\n            '</div>';\n        }\n\n        function isHighImpactUpdate(update) {\n            return (\n                (update.impactLevel === 'Significant' || update.impact_level === 'Significant') ||\n                getBusinessImpactScore(update) >= 7 ||\n                (update.urgency || '').toLowerCase() === 'high'\n            );\n        }\n\n        function getDeadlineDate(update) {\n            const raw = update.compliance_deadline || update.complianceDeadline || update.deadline;\n            if (!raw) return null;\n            const date = new Date(raw);\n            return isNaN(date) ? null : date;\n        }\n\n        function computePriorityHighlights(updates) {\n            if (!updates || !Array.isArray(updates)) return [];\n\n            const now = new Date();\n            const upcomingWindow = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);\n            const highlights = [];\n            const seen = new Set();\n\n            const addHighlight = (update, reason) => {\n                const key = String(update.id || update.url || update.headline || Math.random());\n                if (seen.has(key)) return;\n                seen.add(key);\n                highlights.push({ update, reason });\n            };\n\n            const highImpactUpdates = updates\n                .filter(isHighImpactUpdate)\n                .sort((a, b) => getBusinessImpactScore(b) - getBusinessImpactScore(a));\n\n            highImpactUpdates.forEach(update => addHighlight(update, 'High Impact'));\n\n            const deadlineUpdates = updates\n                .filter(update => {\n                    const deadline = getDeadlineDate(update);\n                    return deadline && deadline >= now && deadline <= upcomingWindow;\n                })\n                .sort((a, b) => getDeadlineDate(a) - getDeadlineDate(b));\n\n            deadlineUpdates.forEach(update => addHighlight(update, 'Upcoming Deadline'));\n\n            const urgentUpdates = updates\n                .filter(update => (update.urgency || '').toLowerCase() === 'high')\n                .sort((a, b) => {\n                    const scoreB = getBusinessImpactScore(b);\n                    const scoreA = getBusinessImpactScore(a);\n                    return scoreB - scoreA;\n                });\n\n            urgentUpdates.forEach(update => addHighlight(update, 'Urgent Task'));\n\n            return highlights.slice(0, 6);\n        }\n\n        function renderPriorityHighlights() {\n            const container = document.getElementById('priorityHighlights');\n            if (!container) return;\n\n            const items = computePriorityHighlights(window.originalUpdates || []);\n            if (!items.length) {\n                container.innerHTML = '<div class=\"priority-empty\">No high impact priorities detected this week. Keep an eye on new updates.</div>';\n                priorityHighlightLookup = {};\n                return;\n            }\n\n            const cards = items.map(({ update, reason }, index) => {\n                const rawId = update.id || update.url || ('priority-' + index);\n                const safeId = rawId.toString().replace(/[^a-zA-Z0-9_-]/g, '_');\n                priorityHighlightLookup[safeId] = update;\n\n                const summarySource = update.ai_summary || update.summary || 'No summary available';\n                const summaryText = truncateText(summarySource, 200);\n                const publishedDate = formatDateDisplay(update.publishedDate || update.published_date || update.fetchedDate || update.createdAt);\n                const deadline = getDeadlineDate(update);\n                const gauge = renderImpactGauge(getBusinessImpactScore(update), true);\n                const urgency = (update.urgency || 'Low').toLowerCase();\n                const reasonClass = reason === 'Upcoming Deadline' ? 'deadline' : 'high-impact';\n                const authority = escapeHtml(update.authority || 'Unknown authority');\n                const headline = escapeHtml(update.headline || 'No headline available');\n                const summaryEscaped = escapeHtml(summaryText);\n                const detailsEscaped = escapeHtml(summarySource);\n                const safeUrl = update.url ? escapeHtml(update.url) : null;\n                const link = safeUrl ? '<a href=\"' + safeUrl + '\" target=\"_blank\" rel=\"noopener\">Open source ^</a>' : '';\n                const reviewedClass = reviewedHighlightIds.has(safeId) ? ' reviewed' : '';\n\n                let card = '';\n                card += '<div class=\"priority-card' + reviewedClass + '\" id=\"priority-card-' + safeId + '\">';\n                card += '<div class=\"priority-card-header\">';\n                card += '<div class=\"priority-card-meta\">';\n                card += '<span class=\"priority-badge ' + reasonClass + '\">' + reason + '</span>';\n                card += '<span class=\"stat-subtext\">' + publishedDate + ' - ' + authority + '</span>';\n                card += '</div>';\n                card += '<button class=\"priority-toggle\" data-priority-toggle=\"' + safeId + '\">Details</button>';\n                card += '</div>';\n                card += '<h3 class=\"priority-card-title\">' + headline + '</h3>';\n                card += '<div class=\"priority-card-summary\" id=\"priority-summary-' + safeId + '\">' + summaryEscaped + '</div>';\n                card += '<div class=\"priority-card-metrics\">';\n                card += gauge;\n                card += '<span class=\"priority-urgency urgency-' + urgency + '\">' + (update.urgency || 'Low') + '</span>';\n                if (deadline) {\n                    card += '<span class=\"priority-deadline\">Due ' + formatDateDisplay(deadline) + '</span>';\n                }\n                card += '</div>';\n                card += '<div class=\"priority-actions\">';\n                card += '<button class=\"priority-action-btn primary\" data-priority-action=\"workspace\" data-highlight-id=\"' + safeId + '\">Add to Workspace</button>';\n                card += '<button class=\"priority-action-btn secondary\" data-priority-action=\"assign\" data-highlight-id=\"' + safeId + '\">Assign Task</button>';\n                card += '<button class=\"priority-action-btn muted\" data-priority-action=\"reviewed\" data-highlight-id=\"' + safeId + '\">Mark as Reviewed</button>';\n                card += '</div>';\n                card += '<div class=\"priority-card-details\" id=\"priority-details-' + safeId + '\">';\n                card += '<p>' + detailsEscaped + '</p>';\n                card += link;\n                card += '</div>';\n                card += '</div>';\n                return card;\n            });\n\n            container.innerHTML = cards.join('');\n\n            if (!container.dataset.priorityBound) {\n                container.addEventListener('click', function(event) {\n                    const toggleBtn = event.target.closest('[data-priority-toggle]');\n                    if (toggleBtn) {\n                        const toggleId = toggleBtn.getAttribute('data-priority-toggle');\n                        if (toggleId && window.PriorityModule && typeof PriorityModule.toggleDetails === 'function') {\n                            PriorityModule.toggleDetails(toggleId);\n                        }\n                        return;\n                    }\n\n                    const actionBtn = event.target.closest('[data-priority-action]');\n                    if (!actionBtn) return;\n                    const action = actionBtn.getAttribute('data-priority-action');\n                    const id = actionBtn.getAttribute('data-highlight-id');\n                    if (action && id && window.PriorityModule && typeof PriorityModule.handleAction === 'function') {\n                        PriorityModule.handleAction(action, id);\n                    }\n                });\n                container.dataset.priorityBound = 'true';\n            }\n        }\n\n        function togglePriorityDetails(id) {\n            const card = document.getElementById('priority-card-' + id);\n            if (!card) return;\n            const expanded = card.classList.toggle('expanded');\n            const toggleBtn = card.querySelector('.priority-toggle');\n            if (toggleBtn) {\n                toggleBtn.textContent = expanded ? 'Hide' : 'Details';\n            }\n        }\n\n        function handlePriorityAction(action, id) {\n            const update = priorityHighlightLookup[id];\n            if (!update) {\n                showMessage('Unable to perform action on this update.', 'error');\n                return;\n            }\n\n            switch (action) {\n                case 'workspace': {\n                    const key = update.url || update.id || id;\n                    if (typeof togglePin === 'function' && key) {\n                        togglePin(key);\n                    }\n                    break;\n                }\n                case 'assign': {\n                    showMessage('Task assigned to compliance team for ' + (update.authority || 'this update'), 'success');\n                    break;\n                }\n                case 'reviewed': {\n                    reviewedHighlightIds.add(id);\n                    const card = document.getElementById('priority-card-' + id);\n                    if (card) {\n                        card.classList.add('reviewed');\n                    }\n                    showMessage('Marked as reviewed', 'info');\n                    break;\n                }\n                default:\n                    showMessage('Action not available yet.', 'warning');\n            }\n        }\n        \n        // =================";
}

module.exports = {
  renderStateManagementSection
}
