function renderFilteringSection() {
  return "        // FILTER AND SORT FUNCTIONS\n        // =================\n        \n        let currentView = typeof window.currentView === 'string' ? window.currentView : 'cards';\n        window.currentView = currentView;\n\n        function cloneUpdates(source) {\n            return Array.isArray(source)\n                ? source.map(update => ({ ...update }))\n                : [];\n        }\n\n        let originalUpdates = cloneUpdates(window.initialUpdates);\n        if (!originalUpdates.length && window.dashboardInitialState?.updates) {\n            originalUpdates = cloneUpdates(window.dashboardInitialState.updates);\n        }\n        let filteredUpdates = [...originalUpdates];\n\n        function hydrateUpdateState(updates) {\n            const cloned = cloneUpdates(updates);\n            originalUpdates = cloned;\n            filteredUpdates = [...originalUpdates];\n            window.originalUpdates = originalUpdates;\n            window.filteredUpdates = filteredUpdates;\n            return cloned.length > 0;\n        }\n\n        hydrateUpdateState(originalUpdates);\n\n        window.currentFilters = Object.assign({ category: 'all', sort: 'newest' }, window.currentFilters || {});\n\n        if (!originalUpdates.length && typeof document !== 'undefined') {\n            document.addEventListener('dashboard:state-ready', (event) => {\n                const updates = event?.detail?.updates || window.dashboardInitialState?.updates || [];\n                if (hydrateUpdateState(updates)) {\n                    applyCurrentFilters();\n                }\n            }, { once: true });\n        }\n\n        function getUpdateDate(update) {\n            const raw = update?.publishedDate || update?.published_date || update?.fetchedDate || update?.createdAt;\n            if (!raw) return null;\n            const parsed = new Date(raw);\n            return isNaN(parsed) ? null : parsed;\n        }\n\n        function isWithinLastDays(update, days) {\n            const date = getUpdateDate(update);\n            if (!date) return false;\n\n            const today = new Date();\n            const startOfToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n\n            if (days === 0) {\n                return date >= startOfToday && date < new Date(startOfToday.getTime() + 24 * 60 * 60 * 1000);\n            }\n\n            const threshold = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));\n            return date >= threshold;\n        }\n\n        function hasDeadline(update) {\n            if (!update) return false;\n            if (update.compliance_deadline || update.complianceDeadline) return true;\n            if (typeof update.keyDates === 'string' && /[0-9]{4}/.test(update.keyDates)) return true;\n            return false;\n        }\n\n        function matchesCategory(update, category) {\n            const normalized = (category || '').toLowerCase();\n            if (!normalized || normalized === 'all') return true;\n\n            const contentType = (update.content_type || update.contentType || '').toLowerCase();\n            const updateCategory = (update.category || '').toLowerCase();\n            const summary = (update.summary || '').toLowerCase();\n            const headline = (update.headline || '').toLowerCase();\n            const aiTags = Array.isArray(update.ai_tags) ? update.ai_tags.map(tag => tag.toLowerCase()) : [];\n\n            switch (normalized) {\n                case 'high-impact':\n                    return (update.impactLevel === 'Significant' || update.impact_level === 'Significant' ||\n                        (update.business_impact_score || 0) >= 7 ||\n                        (update.urgency || '').toLowerCase() === 'high');\n                case 'today':\n                    return isWithinLastDays(update, 0);\n                case 'this-week':\n                case 'thisweek':\n                    return isWithinLastDays(update, 7);\n                case 'consultations':\n                    return contentType.includes('consultation') ||\n                        updateCategory.includes('consultation') ||\n                        headline.includes('consultation') ||\n                        summary.includes('consultation') ||\n                        aiTags.includes('type:consultation');\n                case 'enforcement':\n                    return updateCategory.includes('enforcement') ||\n                        contentType.includes('enforcement') ||\n                        aiTags.includes('has:penalty') ||\n                        headline.includes('fine') ||\n                        summary.includes('fine') ||\n                        summary.includes('penalty');\n                case 'deadlines':\n                    return hasDeadline(update);\n                default:\n                    return updateCategory === normalized || contentType === normalized;\n            }\n        }\n\n        function matchesSector(update, sector) {\n            if (!sector) return true;\n            const target = normalizeSectorLabel(sector);\n            if (!target) return false;\n            const sectors = [].concat(\n                update.firm_types_affected || [],\n                update.primarySectors || [],\n                update.primary_sectors || [],\n                update.sector ? [update.sector] : []\n            )\n            .map(value => normalizeSectorLabel(value))\n            .filter(Boolean);\n            return sectors.includes(target);\n        }\n\n        function matchesSearch(update, term) {\n            if (!term) return true;\n            const needle = term.toLowerCase();\n            const haystack = [\n                update.headline,\n                update.summary,\n                update.ai_summary,\n                update.authority,\n                update.area,\n                update.category,\n                update.content_type,\n                update.contentType\n            ].concat(update.ai_tags || [], update.primarySectors || [], update.firm_types_affected || [])\n                .filter(Boolean)\n                .join(' ')\n                .toLowerCase();\n            return haystack.includes(needle);\n        }\n\n        function filterUpdatesByRange(updates, range) {\n            if (!range) return updates;\n            const normalized = range.toLowerCase();\n            switch (normalized) {\n                case 'today':\n                    return updates.filter(update => isWithinLastDays(update, 0));\n                case 'week':\n                    return updates.filter(update => isWithinLastDays(update, 7));\n                case 'month':\n                    return updates.filter(update => isWithinLastDays(update, 30));\n                case 'quarter':\n                    return updates.filter(update => isWithinLastDays(update, 90));\n                default:\n                    return updates;\n            }\n        }\n\n        function applySort(updates, sortBy) {\n            const sortKey = sortBy || 'newest';\n            const impactOrder = { significant: 3, moderate: 2, informational: 1 };\n            const sorted = [...updates];\n\n            sorted.sort((a, b) => {\n                switch (sortKey) {\n                    case 'oldest':\n                        return (getUpdateDate(a) || 0) - (getUpdateDate(b) || 0);\n                    case 'impact': {\n                        const impactA = (a.impactLevel || a.impact_level || 'Informational').toLowerCase();\n                        const impactB = (b.impactLevel || b.impact_level || 'Informational').toLowerCase();\n                        return (impactOrder[impactB] || 0) - (impactOrder[impactA] || 0);\n                    }\n                    case 'authority': {\n                        const authA = (a.authority || '').toLowerCase();\n                        const authB = (b.authority || '').toLowerCase();\n                        return authA.localeCompare(authB);\n                    }\n                    case 'sector': {\n                        const sectorA = ((a.primarySectors && a.primarySectors[0]) || a.sector || '').toLowerCase();\n                        const sectorB = ((b.primarySectors && b.primarySectors[0]) || b.sector || '').toLowerCase();\n                        return sectorA.localeCompare(sectorB);\n                    }\n                    case 'newest':\n                    default:\n                        return (getUpdateDate(b) || 0) - (getUpdateDate(a) || 0);\n                }\n            });\n\n            return sorted;\n        }\n\n        function setActiveCategoryButton(category) {\n            document.querySelectorAll('.quick-filter-btn').forEach(btn => {\n                const value = btn.getAttribute('data-filter') || 'all';\n                const isActive = value === category;\n                btn.classList.toggle('active', isActive);\n                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');\n            });\n        }\n\n        function updateResultsSummary(updates) {\n            const resultsCount = document.getElementById('results-count');\n            if (resultsCount) {\n                resultsCount.textContent = updates.length;\n            }\n\n            const searchInfo = document.getElementById('search-results');\n            if (searchInfo) {\n                if (window.currentFilters.search) {\n                    searchInfo.style.display = 'block';\n                    searchInfo.textContent = 'Showing results for \"' + window.currentFilters.search + '\"';\n                } else {\n                    searchInfo.style.display = 'none';\n                    searchInfo.textContent = '';\n                }\n            }\n        }\n\n        function normalizeFilterValues(value) {\n            if (value == null) return [];\n            if (Array.isArray(value)) {\n                return value.map(item => String(item).trim()).filter(Boolean);\n            }\n            if (typeof value === 'string') {\n                return value.split(',').map(part => part.trim()).filter(Boolean);\n            }\n            return [String(value).trim()].filter(Boolean);\n        }\n\n        function serializeFilterValue(value) {\n            if (value == null) return '';\n            if (Array.isArray(value)) {\n                return value.join(',');\n            }\n            if (typeof value === 'string') {\n                return value.trim();\n            }\n            return String(value);\n        }\n\n        function syncUrlWithFilters(filters) {\n            const url = new URL(window.location.href);\n            const params = url.searchParams;\n            const keys = ['category', 'authority', 'sector', 'impact', 'urgency', 'range', 'search'];\n\n            keys.forEach(key => {\n                const serialized = serializeFilterValue(filters[key]);\n                if (serialized) {\n                    params.set(key, serialized);\n                } else {\n                    params.delete(key);\n                }\n            });\n\n            const query = params.toString();\n            window.history.replaceState({}, '', url.pathname + (query ? ('?' + query) : ''));\n        }\n\n        function renderUpdatesList(updates) {\n            filteredUpdates = updates;\n            window.filteredUpdates = updates;\n            renderUpdatesInView(currentView, updates);\n            updateResultsSummary(updates);\n            syncUrlWithFilters(window.currentFilters);\n            document.dispatchEvent(new CustomEvent('dashboard:updates-filtered', { detail: { updates } }));\n        }\n\n        async function applyCurrentFilters() {\n            console.log('Target applyCurrentFilters called');\n            const filters = window.currentFilters = Object.assign({ category: 'all', sort: 'newest' }, window.currentFilters || {});\n            console.log('[analytics] Current filters:', filters);\n\n            let updates = originalUpdates.slice();\n            console.log('Package Original updates count:', originalUpdates.length);\n\n            if (filters.category && filters.category !== 'all') {\n                updates = updates.filter(update => matchesCategory(update, filters.category));\n            }\n\n            const authorityValues = normalizeFilterValues(filters.authority);\n            if (authorityValues.length > 0) {\n                const allowedAuthorities = new Set(authorityValues.map(value => value.toLowerCase()));\n                updates = updates.filter(update => allowedAuthorities.has((update.authority || '').toLowerCase()));\n            }\n\n            const sectorValues = normalizeFilterValues(filters.sector);\n            if (sectorValues.length > 0) {\n                updates = updates.filter(update => sectorValues.some(sector => matchesSector(update, sector)));\n            }\n\n            const impactValues = normalizeFilterValues(filters.impact);\n            if (impactValues.length > 0) {\n                const allowedImpacts = new Set(impactValues.map(value => value.toLowerCase()));\n                updates = updates.filter(update => {\n                    const impactLevel = (update.impactLevel || update.impact_level || '').toLowerCase();\n                    return allowedImpacts.has(impactLevel);\n                });\n            }\n\n            const urgencyValues = normalizeFilterValues(filters.urgency);\n            if (urgencyValues.length > 0) {\n                const allowedUrgencies = new Set(urgencyValues.map(value => value.toLowerCase()));\n                updates = updates.filter(update => allowedUrgencies.has((update.urgency || '').toLowerCase()));\n            }\n\n            const rangeValues = normalizeFilterValues(filters.range);\n            if (rangeValues.length > 0) {\n                updates = filterUpdatesByRange(updates, rangeValues[0]);\n            }\n\n            if (filters.search) {\n                updates = updates.filter(update => matchesSearch(update, filters.search));\n            }\n\n            updates = applySort(updates, filters.sort);\n            console.log('Complete After filtering/sorting:', updates.length, 'updates');\n\n            if (shouldFetchFromServer(filters, updates.length)) {\n                const remoteUpdates = await fetchUpdatesFromServer(filters);\n                if (remoteUpdates.length > 0) {\n                    updates = applySort(remoteUpdates, filters.sort);\n                    console.log('Complete Loaded additional updates from server:', updates.length);\n                }\n            }\n\n            setActiveCategoryButton(filters.category || 'all');\n\n            document.querySelectorAll('.sort-btn').forEach(btn => {\n                btn.classList.toggle('active', btn.dataset.sort === filters.sort);\n            });\n\n            console.log('Design Calling renderUpdatesList with', updates.length, 'updates');\n            renderUpdatesList(updates);\n            console.log('Complete renderUpdatesList completed');\n            renderPriorityHighlights();\n        }\n\n\n        async function sortUpdates(sortBy) {\n            const filters = ensureFilterState();\n            filters.sort = sortBy || 'newest';\n            await applyCurrentFilters();\n            showMessage('Sorted by ' + (filters.sort || 'newest'), 'info');\n        }\n\n\n        async function clearAllFilters(options = {}) {\n            const {\n                preserveCategory = false,\n                preserveSort = false,\n                silent = false,\n                skipApply = false\n            } = options;\n\n            console.log('Clearing all filters');\n\n            const current = ensureFilterState();\n            const categoryValue = preserveCategory ? (current.category || 'all') : 'all';\n            const sortValue = preserveSort ? (current.sort || 'newest') : 'newest';\n\n            window.currentFilters = { category: categoryValue, sort: sortValue };\n\n            // Clear search input\n            const searchInput = document.getElementById('search-input');\n            if (searchInput) searchInput.value = '';\n\n            // Clear dropdown selects\n            const authoritySelect = document.querySelector('select[onchange*=\"filterByAuthority\"]');\n            if (authoritySelect) authoritySelect.value = '';\n\n            const sectorSelect = document.querySelector('select[onchange*=\"filterBySector\"]');\n            if (sectorSelect) sectorSelect.value = '';\n\n            const impactSelect = document.querySelector('select[onchange*=\"filterByImpactLevel\"]');\n            if (impactSelect) impactSelect.value = '';\n\n            const rangeSelect = document.querySelector('select[onchange*=\"filterByDateRange\"]');\n            if (rangeSelect) rangeSelect.value = '';\n\n            // Clear checkbox filter sets\n            window.selectedAuthorities.clear();\n            window.selectedImpactLevels.clear();\n            window.selectedUrgencies.clear();\n\n            // Uncheck all filter checkboxes\n            document.querySelectorAll('.authority-checkbox, .impact-checkbox, .urgency-checkbox').forEach(cb => {\n                cb.checked = false;\n            });\n\n            // Reset quick filter buttons\n            document.querySelectorAll('.quick-filter-btn').forEach(btn => {\n                btn.classList.remove('active');\n            });\n            const allBtn = document.querySelector('.quick-filter-btn[data-filter=\"all\"]');\n            if (allBtn) allBtn.classList.add('active');\n\n            // Apply unified filter pipeline (will show all updates)\n            if (!skipApply) {\n                await applyCurrentFilters();\n            }\n\n            if (!silent) {\n                showMessage('All filters cleared', 'info');\n            }\n        }\n\n        function clearFilters() {\n            clearAllFilters();\n        }\n        \n        // =================\n        // UPDATE ACTIONS\n        // =================\n        \n        function viewDetails(updateId) {\n            console.log('Viewing details for:', updateId);\n            window.open('/api/updates/' + updateId, '_blank');\n        }\n        \n        function viewUpdateDetails(updateId, url) {\n            if (updateId) {\n                window.open('/update/' + updateId, '_blank');\n                return;\n            }\n            if (url) {\n                window.open(url, '_blank');\n            }\n        }\n        \n        function bookmarkUpdate(updateId) {\n            console.log('Bookmarking:', updateId);\n            if (!(pinnedUrls instanceof Set)) {\n                pinnedUrls = new Set(Array.isArray(pinnedUrls) ? pinnedUrls : []);\n            }\n            pinnedUrls.add(updateId);\n            if (typeof showMessage === 'function') {\n                showMessage('Update bookmarked', 'success');\n            }\n            updateWorkspaceCounts();\n        }\n        \n        function togglePin(url) {\n            if (!url) return;\n            if (!(pinnedUrls instanceof Set)) {\n                pinnedUrls = new Set(Array.isArray(pinnedUrls) ? pinnedUrls : []);\n            }\n            if (pinnedUrls.has(url)) {\n                pinnedUrls.delete(url);\n                if (typeof showMessage === 'function') {\n                    showMessage('Item unpinned', 'info');\n                }\n            } else {\n                pinnedUrls.add(url);\n                if (typeof showMessage === 'function') {\n                    showMessage('Item pinned', 'success');\n                }\n            }\n            updateWorkspaceCounts();\n        }\n        \n        function shareUpdate(updateId) {\n            console.log('Sharing:', updateId);\n            const url = window.location.origin + '/api/updates/' + updateId;\n            \n            if (navigator.share) {\n                navigator.share({\n                    title: 'Regulatory Update',\n                    url: url\n                }).catch(err => console.log('Share cancelled'));\n            } else {\n                navigator.clipboard.writeText(url).then(() => {\n                    showMessage('Link copied to clipboard', 'success');\n                }).catch(() => {\n                    showMessage('Failed to copy link', 'error');\n                });\n            }\n        }\n        \n        function loadMoreUpdates() {\n            console.log('Document Loading more updates...');\n            \n            const loadMoreBtn = document.getElementById('loadMoreBtn') || \n                               document.querySelector('.btn-secondary');\n            \n            if (loadMoreBtn) {\n                loadMoreBtn.disabled = true;\n                loadMoreBtn.textContent = 'Loading...';\n            }\n            \n            // Get current filters from URL\n            const params = new URLSearchParams(window.location.search);\n            const currentOffset = parseInt(params.get('offset') || '0');\n            const newOffset = currentOffset + 50;\n            params.set('offset', newOffset);\n            \n            // Redirect with new offset\n            window.location.href = '/dashboard?' + params.toString();\n        }\n        \n        // Search functionality - STATE-DRIVEN APPROACH\n        function performSearch() {\n            const searchInput = document.getElementById('search-input');\n            if (!searchInput) return;\n\n            const searchTerm = searchInput.value.trim();\n            const filters = ensureFilterState();\n\n            if (!searchTerm) {\n                delete filters.search;\n            } else {\n                filters.search = searchTerm;\n            }\n\n            // Apply unified filter pipeline\n            applyCurrentFilters();\n        }\n\n        // =================\n        // VIEW SWITCHING FUNCTIONALITY\n        // =================\n\n        function initializeViewSwitching() {\n            const container = ensureUpdatesContainer();\n            if (!container) {\n                console.warn('View switching skipped: updates container missing');\n                return;\n            }\n\n            console.log('[refresh] Initializing view switching...');\n\n            document.querySelectorAll('.view-btn').forEach(btn => {\n                btn.addEventListener('click', (e) => {\n                    const newView = e.target.getAttribute('data-view');\n                    if (newView && newView !== currentView) {\n                        switchView(newView);\n                    }\n                });\n            });\n\n            currentView = typeof window.currentView === 'string' ? window.currentView : currentView;\n            document.querySelectorAll('.view-btn').forEach(btn => {\n                btn.classList.toggle('active', btn.getAttribute('data-view') === currentView);\n            });\n\n            renderUpdatesInView(currentView, window.filteredUpdates);\n        }\n\n        function switchView(viewType) {\n            console.log('[refresh] Switching view to: ' + viewType);\n\n            document.querySelectorAll('.view-btn').forEach(btn => {\n                btn.classList.toggle('active', btn.getAttribute('data-view') === viewType);\n            });\n\n            currentView = viewType;\n            window.currentView = viewType;\n            renderUpdatesInView(viewType, window.filteredUpdates);\n        }\n\n        function ensureUpdatesContainer() {\n            let container = document.getElementById('updates-container') ||\n                document.querySelector('.updates-container');\n\n            if (!container) {\n                const host = document.getElementById('narrativeCard') || document.querySelector('.card');\n                if (host) {\n                    container = document.createElement('div');\n                    container.id = 'updates-container';\n                    container.className = 'updates-container cards-view';\n                    container.innerHTML = buildEmptyStateHtml();\n                    host.appendChild(container);\n                    console.log('[design] Injected fallback updates container');\n                }\n            }\n\n            return container;\n        }\n\n        function renderUpdatesInView(viewType, updates) {\n            const container = ensureUpdatesContainer();\n\n            if (!container) {\n                console.warn('Updates container not found');\n                return;\n            }\n\n            const dataset = updates || window.filteredUpdates || window.originalUpdates || [];\n\n            switch (viewType) {\n                case 'table':\n                    renderTableView(container, dataset);\n                    break;\n                case 'timeline':\n                    renderTimelineView(container, dataset);\n                    break;\n                case 'cards':\n                default:\n                    renderCardsView(container, dataset);\n                    break;\n            }\n        }\n\n        function buildEmptyStateHtml() {\n            return (\n                '<div class=\"no-updates\">' +\n                    '<div class=\"no-updates-icon\">Inbox</div>' +\n                    '<h3>No updates found</h3>' +\n                    '<p>Try adjusting your filters or search criteria.</p>' +\n                    '<button onclick=\"clearAllFilters()\" class=\"btn btn-secondary\">Clear All Filters</button>' +\n                '</div>'\n            );\n        }\n\n        function renderCardsView(container, updates) {\n            container.className = 'updates-container cards-view';\n            if (!updates || updates.length === 0) {\n                container.innerHTML = buildEmptyStateHtml();\n                return;\n            }\n            container.innerHTML = updates.map(update => generateUpdateCard(update)).join('');\n        }\n\n        function renderTableView(container, updates) {\n            container.className = 'updates-container table-view';\n            if (!updates || updates.length === 0) {\n                container.innerHTML = buildEmptyStateHtml();\n                return;\n            }\n\n            const rows = updates.map(update => {\n                const idArg = JSON.stringify(update.id || '');\n                const urlArg = JSON.stringify(update.url || '');\n                const formattedDate = formatDateDisplay(update.publishedDate || update.published_date || update.fetchedDate || update.createdAt);\n                const summary = update.summary || update.ai_summary || '';\n                const impactLevel = (update.impactLevel || update.impact_level || 'Informational');\n                const urgency = update.urgency || 'Low';\n\n                return (\n                    '<tr>' +\n                        '<td>' + formattedDate + '</td>' +\n                        '<td><span class=\"authority-badge\">' + (update.authority || 'Unknown') + '</span></td>' +\n                        '<td class=\"headline-cell\">' +\n                            '<div class=\"headline\">' + (update.headline || 'No headline') + '</div>' +\n                            '<div class=\"summary\">' + summary + '</div>' +\n                        '</td>' +\n                        '<td>' + buildRiskScoreBadge(update, impactLevel) + '</td>' +\n                        '<td><span class=\"urgency-badge ' + urgency.toLowerCase() + '\">' + urgency + '</span></td>' +\n                        '<td><button class=\"table-btn\" onclick=\"viewUpdateDetails(' + idArg + ', ' + urlArg + ')\">View</button></td>' +\n                    '</tr>'\n                );\n            }).join('');\n\n            container.innerHTML =\n                '<div class=\"table-wrapper\">' +\n                    '<table class=\"updates-table\">' +\n                        '<thead>' +\n                            '<tr>' +\n                                '<th>Date</th>' +\n                                '<th>Authority</th>' +\n                                '<th>Headline</th>' +\n                                '<th>Impact</th>' +\n                                '<th>Urgency</th>' +\n                                '<th>Actions</th>' +\n                            '</tr>' +\n                        '</thead>' +\n                        '<tbody>' + rows + '</tbody>' +\n                    '</table>' +\n                '</div>';\n        }\n\n        function renderTimelineView(container, updates) {\n            container.className = 'updates-container timeline-view';\n            if (!updates || updates.length === 0) {\n                container.innerHTML = buildEmptyStateHtml();\n                return;\n            }\n\n            const groupedUpdates = updates.reduce((acc, update) => {\n                const dateLabel = formatDateDisplay(update.publishedDate || update.published_date || update.fetchedDate || update.createdAt);\n                if (!acc[dateLabel]) acc[dateLabel] = [];\n                acc[dateLabel].push(update);\n                return acc;\n            }, {});\n\n            const timelineHTML = '<div class=\"timeline-wrapper\">' +\n                Object.entries(groupedUpdates)\n                    .sort((a, b) => {\n                        const dateA = new Date(a[0]);\n                        const dateB = new Date(b[0]);\n                        return dateB - dateA;\n                    })\n                    .map(([date, dateUpdates]) => (\n                        '<div class=\"timeline-date-group\">' +\n                            '<div class=\"timeline-date-header\">' +\n                                '<h3>' + date + '</h3>' +\n                                '<span class=\"update-count\">' + dateUpdates.length + ' updates</span>' +\n                            '</div>' +\n                            '<div class=\"timeline-updates\">' +\n                                dateUpdates.map(update => {\n                                    const idArg = JSON.stringify(update.id || '');\n                                    const urlArg = JSON.stringify(update.url || '');\n                                    const urgency = update.urgency || 'Low';\n                                    const summary = update.summary || update.ai_summary || '';\n\n                                    return (\n                                        '<div class=\"timeline-item\">' +\n                                            '<div class=\"timeline-marker\"></div>' +\n                                            '<div class=\"timeline-content\">' +\n                                                '<div class=\"timeline-header\">' +\n                                                    '<span class=\"authority-badge\">' + (update.authority || 'Unknown') + '</span>' +\n                                                    '<span class=\"urgency-badge ' + urgency.toLowerCase() + '\">' + urgency + '</span>' +\n                                                '</div>' +\n                                                '<h4 class=\"timeline-headline\">' + (update.headline || 'No headline') + '</h4>' +\n                                                '<p class=\"timeline-summary\">' + summary + '</p>' +\n                                                '<button class=\"timeline-btn\" data-update-id=\"' + (update.id || '') + '\" data-update-url=\"' + (update.url || '#') + '\">View Details</button>' +\n                                            '</div>' +\n                                        '</div>'\n                                    );\n                                }).join('') +\n                            '</div>' +\n                        '</div>'\n                    )).join('') +\n                '</div>';\n\n            container.innerHTML = timelineHTML;\n        }\n\n        \n        function ensureFilterState(overrides = {}) {\n            const baseline = Object.assign({ category: 'all', sort: 'newest' }, window.currentFilters || {});\n            const merged = Object.assign({}, baseline, overrides || {});\n            window.currentFilters = merged;\n            return merged;\n        }\n\n        function collectFiltersFromControls() {\n            const filters = ensureFilterState();\n            const collected = new Map();\n\n            const filterForm = document.querySelector('.filters-grid');\n            if (filterForm) {\n                const formData = new FormData(filterForm);\n                ['category', 'authority', 'sector', 'impact', 'range', 'search', 'sort'].forEach((key) => {\n                    if (formData.has(key)) {\n                        collected.set(key, formData.get(key));\n                    }\n                });\n            }\n\n            const dataInputs = document.querySelectorAll('[data-filter]');\n            dataInputs.forEach((input) => {\n                const key = input.getAttribute('data-filter');\n                if (!key) return;\n\n                if (input.type === 'checkbox') {\n                    const list = collected.has(key)\n                        ? [].concat(collected.get(key) || [])\n                        : [];\n                    if (input.checked) {\n                        list.push(input.value);\n                    }\n                    collected.set(key, list);\n                } else if (input.type === 'radio') {\n                    if (input.checked) {\n                        collected.set(key, input.value);\n                    } else if (!collected.has(key)) {\n                        collected.set(key, '');\n                    }\n                } else {\n                    collected.set(key, input.value);\n                }\n            });\n\n            const searchInput = document.getElementById('search-input') || document.getElementById('searchBox') || document.getElementById('search');\n            if (searchInput) {\n                collected.set('search', searchInput.value);\n            }\n\n            collected.forEach((rawValue, key) => {\n                if (Array.isArray(rawValue)) {\n                    const normalizedValues = rawValue.map(value => String(value || '').trim()).filter(Boolean);\n                    if (normalizedValues.length) {\n                        filters[key] = normalizedValues.join(',');\n                    } else {\n                        delete filters[key];\n                    }\n                    return;\n                }\n\n                const value = rawValue != null ? String(rawValue).trim() : '';\n                if (!value) {\n                    if (key === 'category') {\n                        filters[key] = 'all';\n                    } else if (key === 'sort') {\n                        filters[key] = filters.sort || 'newest';\n                    } else {\n                        delete filters[key];\n                    }\n                } else {\n                    filters[key] = value;\n                }\n            });\n\n            if (!('category' in filters) || !filters.category) {\n                filters.category = 'all';\n            }\n\n            if (!('sort' in filters) || !filters.sort) {\n                filters.sort = 'newest';\n            }\n\n            window.currentFilters = filters;\n            return filters;\n        }\n\n        function syncSelectedFilterSets(filters) {\n            const authorityValues = normalizeFilterValues(filters.authority);\n            if (window.selectedAuthorities instanceof Set) {\n                window.selectedAuthorities.clear();\n                authorityValues.forEach((value) => window.selectedAuthorities.add(value));\n            }\n\n            const impactValues = normalizeFilterValues(filters.impact);\n            if (window.selectedImpactLevels instanceof Set) {\n                window.selectedImpactLevels.clear();\n                impactValues.forEach((value) => window.selectedImpactLevels.add(value));\n            }\n\n            const urgencyValues = normalizeFilterValues(filters.urgency);\n            if (window.selectedUrgencies instanceof Set) {\n                window.selectedUrgencies.clear();\n                urgencyValues.forEach((value) => window.selectedUrgencies.add(value));\n            }\n        }\n\n        async function applyActiveFilters() {\n            const filters = collectFiltersFromControls();\n            setActiveCategoryButton(filters.category || 'all');\n            syncSelectedFilterSets(filters);\n            return applyCurrentFilters();\n        }\n\n        function filterByCategory(category) {\n            const filters = ensureFilterState({ category: category || 'all' });\n            setActiveCategoryButton(filters.category);\n            syncSelectedFilterSets(filters);\n            return applyCurrentFilters();\n        }\n\n        function filterByAuthority(authority) {\n            const filters = ensureFilterState();\n            if (authority) {\n                filters.authority = authority;\n            } else {\n                delete filters.authority;\n            }\n            syncSelectedFilterSets(filters);\n            return applyCurrentFilters();\n        }\n\n        function filterBySector(sector) {\n            const filters = ensureFilterState();\n            if (sector) {\n                filters.sector = sector;\n            } else {\n                delete filters.sector;\n            }\n            return applyCurrentFilters();\n        }\n\n        function filterByImpactLevel(level) {\n            const filters = ensureFilterState();\n            if (level) {\n                filters.impact = level;\n            } else {\n                delete filters.impact;\n            }\n            syncSelectedFilterSets(filters);\n            return applyCurrentFilters();\n        }\n\n        function filterByDateRange(range) {\n            const filters = ensureFilterState();\n            if (range) {\n                filters.range = range;\n            } else {\n                delete filters.range;\n            }\n            return applyCurrentFilters();\n        }\n\n        function filterByUrgency(urgency) {\n            const filters = ensureFilterState();\n            if (urgency) {\n                filters.urgency = urgency;\n            } else {\n                delete filters.urgency;\n            }\n            syncSelectedFilterSets(filters);\n            return applyCurrentFilters();\n        }\n\n        window.ensureFilterState = ensureFilterState;\n        window.applyActiveFilters = applyActiveFilters;\n        window.applyCurrentFilters = applyCurrentFilters;\n        window.filterByCategory = filterByCategory;\n        window.filterByAuthority = filterByAuthority;\n        window.filterBySector = filterBySector;\n        window.filterByImpactLevel = filterByImpactLevel;\n        window.filterByDateRange = filterByDateRange;\n        window.filterByUrgency = filterByUrgency;\n        window.sortUpdates = sortUpdates;\n        window.switchView = switchView;\n        window.loadMoreUpdates = loadMoreUpdates;\n        window.clearFilters = clearFilters;\n        window.clearAllFilters = clearAllFilters;\n        window.performSearch = performSearch;\n        window.viewDetails = viewDetails;\n        window.viewUpdateDetails = viewUpdateDetails;\n        window.bookmarkUpdate = bookmarkUpdate;\n        window.shareUpdate = shareUpdate;\n        window.togglePin = togglePin;\n        // =================";
}

module.exports = {
  renderFilteringSection
}
